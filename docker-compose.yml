services:
  # ==========================================
  # DATABASE CLUSTER (4 Nodes, 16 Shards)
  # ==========================================
  postgres_00:
    build:
      context: .
      dockerfile: Dockerfile.sharding.db
    hostname: postgres_00
    environment:
      POSTGRES_PASSWORD: "09125689"
    ports:
      - "5432:5432"
    command: ["postgres", "-c", "wal_level=logical"]

  postgres_01:
    build:
      context: .
      dockerfile: Dockerfile.sharding.db
    hostname: postgres_01
    environment:
      POSTGRES_PASSWORD: "09125689"
    ports:
      - "5433:5432"
    command: ["postgres", "-c", "wal_level=logical"]

  postgres_02:
    build:
      context: .
      dockerfile: Dockerfile.sharding.db
    hostname: postgres_02
    environment:
      POSTGRES_PASSWORD: "09125689"
    ports:
      - "5434:5432"
    command: ["postgres", "-c", "wal_level=logical"]

  postgres_03:
    build:
      context: .
      dockerfile: Dockerfile.sharding.db
    hostname: postgres_03
    environment:
      POSTGRES_PASSWORD: "09125689"
    ports:
      - "5435:5432"
    command: ["postgres", "-c", "wal_level=logical"]

  # ==========================================
  # UTILITIES
  # ==========================================

  # Створює таблиці travel_plans/locations у всіх базах
  schema-init:
    build:
      context: .
      dockerfile: Dockerfile.sharding
    container_name: traveler-schema-init
    depends_on:
      - postgres_00
      - postgres_01
      - postgres_02
      - postgres_03

  # ==========================================
  # BACKEND API (Spring Boot)
  # ==========================================
  app:
    build: .
    ports:
      - "8080:8080"
    environment:
      SPRING_JPA_HIBERNATE_DDL_AUTO: none
      SPRING_JPA_SHOW_SQL: "true"
    volumes:
      - shared_config:/config
    depends_on:
      postgres_00:
        condition: service_started
      schema-init:
        condition: service_completed_successfully

  # ==========================================
  # FRONTEND (React) - User GUI
  # ==========================================
  frontend:
    build: ./frontend
    ports:
      - "5173:5173"
    volumes:
      - ./frontend:/app
      - /app/node_modules
    environment:
      - CHOKIDAR_USEPOLLING=true
    depends_on:
      - app

  # ==========================================
  # ADMIN DASHBOARD (Streamlit) - Shard Manager
  # ==========================================
  admin-dashboard:
    build:
      context: .
      dockerfile: Dockerfile.cli
    container_name: shard-admin
    command: ["-m", "streamlit", "run", "admin_dashboard.py", "--server.port=8501", "--server.address=0.0.0.0"]
    ports:
      - "8501:8501"
    volumes:
      - .:/app # Монтуємо код, щоб бачити admin_dashboard.py та rebalance.py
      - shared_config:/config
    environment:
      - AM_I_IN_DOCKER=true
    depends_on:
      - postgres_00

volumes:
  shared_config: